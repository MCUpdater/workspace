import org.apache.tools.ant.filters.*

def sharedVersion = new Version(major: 3, minor: 3, buildNum: 3)

buildscript {
	repositories { mavenCentral() }
	dependencies { classpath 'org.ajoberstar:gradle-git:0.2.3' }
}

subprojects {
	apply plugin: 'java'
	group = 'org.mcupdater'

	repositories {
		mavenCentral()
	}
}

import org.ajoberstar.gradle.git.tasks.*

task cloneAPI(type: GitClone) {
	def destination = file("MCU-API")
	uri = "https://github.com/MCUpdater/MCU-API.git"
	destinationPath = destination
	bare = false
	enabled = !destination.exists()
}

task cloneDownloadLib(type: GitClone) {
	def destination = file("MCU-DownloadLib")
	uri = "https://github.com/MCUpdater/MCU-DownloadLib.git"
	destinationPath = destination
	bare = false
	enabled = !destination.exists()
}

task cloneYggdrasil(type: GitClone) {
	def destination = file("MCU-Yggdrasil")
	uri = "https://github.com/MCUpdater/MCU-Yggdrasil.git"
	destinationPath = destination
	bare = false
	enabled = !destination.exists()
}

task cloneBootstrap(type: GitClone) {
	def destination = file("MCU-Bootstrap")
	uri = "https://github.com/MCUpdater/MCU-Bootstrap.git"
	destinationPath = destination
	bare = false
	enabled = !destination.exists()
}

task cloneGUISwing(type: GitClone) {
	def destination = file("GUI-Swing")
	uri = "https://github.com/MCUpdater/GUI-Swing.git"
	destinationPath = destination
	bare = false
	enabled = !destination.exists()
}

task cloneGUIJavaFx(type: GitClone) {
	def destination = file("GUI-JavaFx")
	uri = "https://github.com/MCUpdater/GUI-JavaFx.git"
	destinationPath = destination
	bare = false
	enabled = !destination.exists()
}

task cloneGUIMinimal(type: GitClone) {
	def destination = file("GUI-Minimal")
	uri = "https://github.com/MCUpdater/GUI-Minimal.git"
	destinationPath = destination
	bare = false
	enabled = !destination.exists()
}

task cloneFastPack(type: GitClone) {
	def destination = file("FastPack")
	uri = "https://github.com/MCUpdater/FastPack.git"
	destinationPath = destination
	bare = false
	enabled = !destination.exists()
}

task clonePackBuilder(type: GitClone) {
	def destination = file("PackBuilder")
	uri = "https://github.com/MCUpdater/PackBuilder.git"
	destinationPath = destination
	bare = false
	enabled = !destination.exists()
}

task cloneLauncher(type: GitClone) {
	def destination = file("MCU-Launcher")
	uri = "https://github.com/MCUpdater/MCU-Launcher.git"
	destinationPath = destination
	bare = false
	enabled = !destination.exists()
}

task setupWorkspace << {
	println 'Workspace ready'
}

setupWorkspace.dependsOn {
	tasks.findAll { task -> task.name.startsWith('clone') }
}

task gatherArtifacts << {
	File assembledDir = mkdir("$buildDir/Artifacts")
	subprojects.each { project ->
		project.tasks.withType(Jar).each { archiveTask ->
			copy {
				from archiveTask.archivePath
				into assembledDir
			}
		}
	}
}

task copyDeps << {
	subprojects {subprj->
		def allDeps = []
		def sources = ['runtime', 'compile', 'providedRuntime', 'providedCompile']
		subprj.configurations.asMap.each {k, v->
			if (k in sources) {
				allDeps.addAll v.allDependencies
			}
		}
		copy{
			from allDeps.collect { dep->
				if (!(dep instanceof ProjectDependency)) {//exclude project deps
					//noinspection GroovyAssignabilityCheck
					def files =  subprj.configurations.compile.files (dep)
					files.collect { f->
						f.path
					}
				} else {
					[]
				}
			}
			into "${rootProject.projectDir}/copy"
		}
	}
}

task build(dependsOn: setupWorkspace) {}

class Version {
	int major, minor, buildNum

	String toString() {
		if (buildNum != 0) {
			"$major.$minor.$buildNum"
		} else {
			"$major.$minor"
		}
	}
}

project(':MCU-Yggdrasil') {
	version = '1.0'
	dependencies {
		compile 'com.google.code.gson:gson:2.2.4'
	}
}

project(':MCU-DownloadLib') {
	version = new Version(major: 1, minor: 4)
	sourceCompatibility = 1.6

	afterEvaluate {
		processResources {
			include '**/*.properties'
			filter(ReplaceTokens, tokens: [verMajor: Integer.toString(version.major), verMinor: Integer.toString(version.minor), verBuild: Integer.toString(version.buildNum)])
			println("Version " + version)
		}
	}

	dependencies {
		compile 'commons-codec:commons-codec:1.9'
		compile 'commons-io:commons-io:2.4'
		compile 'org.tukaani:xz:1.4'
	}
}

project(':MCU-API') {
	version = sharedVersion
	sourceCompatibility = 1.7

	afterEvaluate {
		processResources {
			from(sourceSets*.resources.srcDirs) {
				include '**/*.properties'
				filter(ReplaceTokens, tokens: [verMajor: Integer.toString(version.major), verMinor: Integer.toString(version.minor), verBuild: Integer.toString(version.buildNum)])
			}
			from(sourceSets*.resources.srcDirs) {
				exclude '**/*.properties'
			}
		}
	}

	dependencies {
		compile project(':MCU-DownloadLib')
		compile project(':MCU-Yggdrasil')
		compile 'commons-codec:commons-codec:1.9'
		compile 'commons-io:commons-io:2.4'
		compile 'com.google.code.gson:gson:2.2.4'
	}
}

project(':MCU-Bootstrap') {
	version = '1.2'
	sourceCompatibility = 1.6

	dependencies {
		compile project(':MCU-DownloadLib')
		compile 'net.sf.jopt-simple:jopt-simple:4.6'
		compile 'org.apache.commons:commons-lang3:3.2.1'
	}

	jar {
		archiveName = 'MCU-Bootstrap.jar'
		from configurations.compile.collect { it.isDirectory() ? it : zipTree(it) }
		manifest {
			attributes "Main-Class": 'org.mcupdater.BootstrapForm'
		}
	}
}

project(':GUI-Swing') {
	version = sharedVersion
	sourceCompatibility = 1.7

	afterEvaluate {
		processResources {
			from(sourceSets*.resources.srcDirs) {
				include '**/*.properties' filter(ReplaceTokens, tokens: [verMajor: Integer.toString(version.major), verMinor: Integer.toString(version.minor), verBuild: Integer.toString(version.buildNum)])
			}
			from(sourceSets*.resources.srcDirs) { exclude '**/*.properties' }
		}
	}
	dependencies {
		compile project(':MCU-API')
		compile project(':MCU-DownloadLib')
		compile project(':MCU-Yggdrasil')
		compile 'org.apache.commons:commons-lang3:3.2.1'
		compile 'net.sf.jopt-simple:jopt-simple:4.6'
		compile 'commons-io:commons-io:2.4'
		compile 'com.google.code.gson:gson:2.2.4'
		compile 'org.swinglabs.swingx:swingx-all:1.6.5'
		compile files("${System.properties['java.home']}/lib/jfxrt.jar")
	}

	jar {
		baseName = "MCU"
	}
}

project(':GUI-JavaFx') {
	version = sharedVersion
	sourceCompatibility = 1.7

	afterEvaluate {
		processResources {
			from(sourceSets*.resources.srcDirs) {
				include '**/*.properties' filter(ReplaceTokens, tokens: [verMajor: Integer.toString(version.major), verMinor: Integer.toString(version.minor), verBuild: Integer.toString(version.buildNum)])
			}
			from(sourceSets*.resources.srcDirs) { exclude '**/*.properties' }
		}
	}
	dependencies {
		compile project(':MCU-API')
		compile project(':MCU-DownloadLib')
		compile project(':MCU-Yggdrasil')
		compile 'org.apache.commons:commons-lang3:3.2.1'
		compile 'net.sf.jopt-simple:jopt-simple:4.6'
		compile 'commons-io:commons-io:2.4'
		compile 'com.google.code.gson:gson:2.2.4'
		compile files("${System.properties['java.home']}/lib/jfxrt.jar")
	}
}

project(':GUI-Minimal') {
	version = sharedVersion
	sourceCompatibility = 1.7

	afterEvaluate {
		processResources {
			from(sourceSets*.resources.srcDirs) {
				include '**/*.properties' filter(ReplaceTokens, tokens: [verMajor: Integer.toString(version.major), verMinor: Integer.toString(version.minor), verBuild: Integer.toString(version.buildNum)])
			}
			from(sourceSets*.resources.srcDirs) { exclude '**/*.properties' }
		}
	}
	dependencies {
		compile project(':MCU-API')
		compile project(':MCU-DownloadLib')
		compile project(':MCU-Yggdrasil')
		compile 'org.apache.commons:commons-lang3:3.2.1'
		compile 'net.sf.jopt-simple:jopt-simple:4.6'
		compile 'commons-io:commons-io:2.4'
		compile 'com.google.code.gson:gson:2.2.4'
	}

	jar {
		baseName = 'MCU-Minimal'
	}
}

project(':PackBuilder') {
	sourceCompatibility = 1.7
	dependencies {
		compile project(':MCU-API')
		compile 'net.sf.jopt-simple:jopt-simple:4.6'
		compile files("${System.properties['java.home']}/lib/jfxrt.jar")
	}
}

project(':FastPack') {
	version = new Version(major: 1, minor: 5, buildNum: 3)
	sourceCompatibility = 1.7

	dependencies {
		compile project(':MCU-API')
		compile 'net.sf.jopt-simple:jopt-simple:4.6'
		compile 'commons-codec:commons-codec:1.9'
		compile 'org.apache.commons:commons-lang3:3.2.1'
		compile 'com.google.code.gson:gson:2.2.4'
	}

	jar {
		baseName = 'MCU-FastPack'
		from configurations.compile.collect { it.isDirectory() ? it : zipTree(it) }
		manifest {
			attributes "Main-Class": 'org.mcupdater.fastpack.FastPack'
		}
	}
}

project(':MCU-Launcher') {
	version = new Version(major: 1, minor: 0)
	sourceCompatibility = 1.7

	jar {
		archiveName = "MCU-Launcher.jar"
	}
}
